<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Payload Box</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* Hide scrollbars but keep functionality */
    * {
      scrollbar-width: none;  /* Firefox */
      -ms-overflow-style: none;  /* IE and Edge */
    }
    *::-webkit-scrollbar {
      display: none;  /* Chrome, Safari and Opera */
    }

    /* Global styles */
    :root {
      /* Light Theme (default) */
      --sidebar-bg: #26314F;
      --sidebar-text: #fff;
      --primary: #1976d2;
      --primary-dark: #0d47a1;
      --card-bg: #fff;
      --text-primary: #1a1a1a;
      --text-secondary: #4a4a4a;
      --bg-primary: #f4f7fe;
      --bg-secondary: #fff;
      --border-color: #e0e0e0;
      --hover-bg: #f5f5f5;
      --border-radius: 9px;
      --shadow: 0 2px 10px rgba(5,10,30,0.05);
      --font: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    /* Dark Theme */
    [data-theme="dark"] {
      --sidebar-bg: #1a2236;
      --sidebar-text: #e0e0e0;
      --primary: #64b5f6;
      --primary-dark: #42a5f5;
      --card-bg: #1e293b;
      --text-primary: #f0f0f0;
      --text-secondary: #b0b0b0;
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --border-color: #2d3748;
      --hover-bg: #2d3748;
      --shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }
    html, body {
      height: 100%;
      width: 100%;
      padding: 0;
      margin: 0;
    }
    body {
      box-sizing: border-box;
      font-family: var(--font);
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      width: 100vw;
      overflow: hidden;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    .layout {
      display: flex;
      height: 100vh;
      width: 100vw;
      min-width: 0;
    }
    .sidebar {
      background: var(--sidebar-bg);
      color: var(--sidebar-text);
      width: 250px;
      min-width: 200px;
      max-width: 280px;
      display: flex;
      flex-direction: column;
      padding: 0;
      box-shadow: 2px 0 12px #0002;
      height: 100%;
    }
    .sidebar-header {
      padding: 1.5rem 1.3rem;
      font-size: 1.36rem;
      font-weight: 700;
      letter-spacing: 0.01em;
      background: var(--sidebar-bg);
      border-bottom: 1.5px solid var(--border-color);
      user-select: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .sidebar-main {
      flex: 1;
      overflow-y: auto;
      padding: 12px 12px 15px 12px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      gap: 10px;
      /* Hide scrollbar for Chrome, Safari and Opera */
      scrollbar-width: none;  /* Firefox */
      -ms-overflow-style: none;  /* IE and Edge */
    }
    .sidebar-main h3 {
      font-weight: 500;
      margin: 6px 0 8px 0;
      color: #b8ddff;
      font-size: 0.95rem;
    }
    #endpointList {
      list-style: none;
      margin: 0;
      padding: 0 0 6px 0;
      border-radius: 6px;
      background: #283d62;
      box-shadow: var(--shadow);
      max-height: 200px;
      overflow-y: auto;
      overflow-x: hidden;
      font-size: 0.85rem;
      /* Hide scrollbar for Chrome, Safari and Opera */
      scrollbar-width: none;  /* Firefox */
      -ms-overflow-style: none;  /* IE and Edge */
    }
    #endpointList li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      padding: 6px 8px 6px 12px;
      border-bottom: 1px solid var(--border-color);
      color: var(--sidebar-text);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9em;
      line-height: 1.4;
      max-width: 100%;
      text-overflow: ellipsis;
      overflow: hidden;
      white-space: nowrap;
      min-height: 32px;
    }
    #endpointList li.selected {
      background: #1452bb;
      color: #fff;
      font-weight: 700;
    }
    #endpointList li:last-child { border-bottom: none;}
    #endpointList li .list-label {
      flex: 1 1 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-weight: 400;
      color: #e0e0e0;
      min-width: 0;
      padding-right: 8px;
      cursor: default;
      font-size: 0.9em;
      letter-spacing: 0.01em;
      opacity: 0.95;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .new-webhook-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      background-color: #ff4444;
      border-radius: 50%;
      margin-right: 6px;
      flex-shrink: 0;
    }
    #endpointList li:hover .list-label {
      color: #fff;
      opacity: 1;
    }
    .endpoint-actions {
      display: flex;
      gap: 4px;
      flex-shrink: 0;
      min-width: 0;
    }
    .endpoint-actions button {
      background: none;
      border: none;
      color: #ff4444;
      font-size: 1.1em;
      cursor: pointer;
      width: 26px;
      height: 26px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.2s ease;
      opacity: 0.8;
    }
    .endpoint-actions button:hover { 
      background-color: rgba(255, 107, 107, 0.1);
      opacity: 1;
      transform: scale(1.1);
    }
    .endpoint-actions button:active {
      transform: scale(0.95);
    }
    .sidebar button, .sidebar input[type=button] {
      margin: 10px 0;
      width: 100%;
      font-size: 0.95rem;
      font-weight: 700;
      padding: 10px 0;
      border: none;
      border-radius: 6px;
      background: #48aaff;
      color: #fff;
      cursor: pointer;
      transition: background .2s;
      box-shadow: 0 4px 22px #0054a20a;
    }
    .sidebar button:disabled {
      background: #3e4d67;
      color: #aaa;
      cursor: default;
    }
    .sidebar button:not(:disabled):hover { background: var(--primary-dark);}
    #g_idsignin-container {
      margin-bottom: 30px;
    }
    #userInfo {
      background: #243b54;
      color: #fff;
      padding: 10px 12px;
      border-radius: 7px;
      margin-top: auto;
      font-size: 0.95rem;
      display: none;
      flex-direction: column;
      max-width: 100%;
      min-width: 0;
    }
    #userEmail {
      font-weight: 700;
      line-height: 1.18;
      margin-bottom: 8px;
      word-break: break-all;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 95%;
      min-width: 0;
      cursor: pointer;
    }
    #logoutBtn {
      background-color: #f44336;
      color: white;
      border: none;
      padding: 7px 13px;
      font-size: 1rem;
      font-weight: 700;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 0;
      margin-bottom: 4px;
      align-self: flex-start;
      max-width: 120px;
    }
    #logoutBtn:hover { background: #b71c1c; }
    .main-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 0;
      height: 100vh;
      background: #f3f5fa;
      min-width: 0;
    }
    .main-inner-content {
      padding: 22px 38px 10px 38px;
      width: 100%;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 22px;
      overflow-y: auto;
      flex: 1;
      box-sizing: border-box;
    }
    .endpoint-url-row {
      display: flex;
      align-items: center;
      gap: 17px;
      width: 100%;
      min-width: 0;
    }
    #endpointUrl {
      flex-grow: 1;
      background: #e2f2fd;
      border: 2.1px solid var(--primary);
      border-radius: 8px;
      color: #1469d5;
      font-weight: 700;
      font-size: 1.04rem;
      padding: 10px 14px;
      user-select: all;
      letter-spacing: 0.018em;
      word-break: break-all;
      min-width: 50px;
      width: 100%;
      transition: box-shadow .2s;
    }
    #copyEndpointBtn {
      background: var(--primary);
      border: none;
      border-radius: 7px;
      color: white;
      font-weight: 700;
      font-size: 1rem;
      padding: 13px 28px;
      cursor: pointer;
      transition: background 0.2s;
      box-shadow: 0 0 10px #2067c620;
    }
    #copyEndpointBtn:disabled {
      background-color: #bbb;
      cursor: default;
    }
    #copyEndpointBtn:hover:not(:disabled) {
      background: var(--primary-dark);
    }
    .toggle-details-btn {
      background: var(--primary);
      color: white;
      font-weight: 700;
      font-size: 1.04rem;
      border: none;
      border-radius: 8px;
      padding: 9px 20px;
      margin: 8px 0;
      align-self: flex-start;
      cursor: pointer;
      transition: background .2s;
    }
    .toggle-details-btn[aria-pressed="true"]{ background: var(--primary-dark);}
    .toggle-details-btn:hover { background: var(--primary-dark);}
    .requests-table-container {
      width: 100%;
      min-width: 0;
      overflow-x: auto;
      max-height: 70vh;
      background: #fff;
      border-radius: 12px;
      box-shadow: var(--shadow);
      border: 1px solid #d5e1fa;
      padding: 0;
      margin: 0;
      box-sizing: border-box;
      display: block;
    }
    table {
      width: 100%;
      min-width: 0;
      max-width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      font-size: 1rem;
    }
    thead {
      background: #e4f1ff;
      color: #135493;
      font-size: 1.10em;
      font-weight: 700;
      position: sticky;
      top: 0;
      z-index: 9;
    }
    th, td {
      border: 1px solid #dbe5ef;
      padding: 10px 8px;
      vertical-align: top;
      word-break: break-word;
      overflow-wrap: break-word;
      background: #fff;
      min-width: 0;
      max-width: 100vw;
      box-sizing: border-box;
    }
    /* Increased width from 82px to 120px */
    th:first-child, td:first-child {
      width: 120px;
      text-align: center;
    }
    tbody tr:hover { background: #e3f3fc; }
    /* Highlight unopened requests */
    tbody tr.unopened {
      background-color: #fff9db;
      font-weight: 700;
    }
    .method-badge, .detail-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.7em;
      font-weight: bold;
      text-transform: uppercase;
      color: white;
      margin-left: 6px;
      vertical-align: middle;
      cursor: help;
    }
    .detail-icon {
      background: #555;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      padding: 0;
      font-size: 0.8em;
    }
    .detail-icon.headers { background: #4a6da7; }
    .detail-icon.query { background: #5e8b5e; }
    
    /* Copy button styles */
    .copy-btn {
      background: none;
      border: 1px solid #ccc;
      border-radius: 4px;
      color: #666;
      cursor: pointer;
      font-size: 0.8em;
      margin-left: 8px;
      padding: 2px 6px;
      transition: all 0.2s;
    }
    .copy-btn:hover {
      background: #f0f0f0;
      border-color: #999;
    }
    .copy-btn.copied {
      background: #4CAF50;
      border-color: #45a049;
      color: white;
    }
    .method-badge {
      display: inline-block;
      background: var(--primary);
      color: white;
      font-weight: 700;
      font-size: .82rem;
      text-transform: uppercase;
      border-radius: 100px;
      padding: 3px 12px;
      margin-left: 8px;
      user-select: none;
      box-shadow: 0 1px 2px rgba(0,0,0,0.10);
    }
    .method-badge.GET { background: #13b772;}
    .method-badge.POST { background: #217bee;}
    .method-badge.PUT { background: #ffba39;}
    .method-badge.DELETE { background: #ef5350;}
    .method-badge.PATCH { background: #8b5cf6;}
    .method-badge.OTHER { background: #607d8b;}
    details {
      border: 1px solid #c3cfec;
      background: #f4f8ff;
      border-radius: 7px;
      margin-top: 7px;
      margin-bottom: 6px;
      box-shadow: 0 0 4px #a4bbf829;
    }
    summary {
      font-weight: 700;
      padding: 11px 17px;
      cursor: pointer;
      user-select: none;
      font-size: 1.02rem;
      color: #1369a8;
      display: flex;
      align-items: center;
      gap: 9px;
      outline: none;
    }
    summary::-webkit-details-marker { display: none; }
    details[open]{ border-color: #1d1354; }
    details[open] summary { color: var(--primary); }
    pre {
      margin: 0;
      padding: 12px 20px;
      font-family: 'Fira Mono', monospace;
      font-size: .93rem;
      background-color: #22223c;
      color: #cddbff;
      white-space: pre-wrap;
      max-height: 280px;
      overflow-y: auto;
      border-radius: 0 0 7px 7px;
      border-top: 2px solid #94bcf2;
      box-shadow: 0 1px 8px #5f8aff0c inset;
      user-select: text;
    }
    .no-requests {
      margin: 80px auto;
      color: #7695be;
      text-align: center;
      font-size: 1.18rem;
      opacity: 0.73;
      letter-spacing: 0.03em;
    }
    @media (max-width: 900px) {
      .main-inner-content {
        padding: 16px 8px 8px 8px;
        width: 100vw;
      }
      .sidebar { width: 196px; min-width: 120px;}
      .sidebar-header, .sidebar-footer {padding: 0.7rem 0.9rem;}
      .requests-table-container { padding: 0; }
    }
    @media (max-width: 730px) {
      .layout { flex-direction: column; height: auto; }
      .sidebar { width: 100vw; max-width: none; min-width: unset; box-shadow: none;}
      .main-inner-content { padding: 10px 2vw; }
      .requests-table-container { padding: 0; }
    }
  </style>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
<!-- Connection lost banner -->
<div id="connectionBanner" style="
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%;
  background:#ff4747;
  color:#fff;
  font-weight:700;
  padding:12px 0;
  text-align:center;
  z-index:999;
">
  Connection lost.
  <button id="reloadBtn" style="
    margin-left:15px;
    background:#fff;
    color:#ff4747;
    border:none;
    padding:6px 14px;
    border-radius:5px;
    font-weight:700;
    cursor:pointer;
  ">Reload</button>
</div>
<div class="layout">
  <aside class="sidebar" aria-label="Sidebar">
    <div class="sidebar-header">
  <span>Payload Box</span>
</div>
    <div class="sidebar-main">
      <button id="newEndpointBtn" disabled>Create New Endpoint</button>
      <h3>Your Endpoints</h3>
      <ul id="endpointList" tabindex="0" role="listbox"></ul>
      <div id="g_idsignin-container" aria-label="Google Sign-in container">
        <div id="g_idsignin" role="button" aria-label="Google Sign-in Button"></div>
      </div>
      <div id="userInfo" aria-live="polite" aria-atomic="true" aria-label="User information panel">
        <div id="userEmail" tabindex="0" title=""></div>
        <button id="logoutBtn" aria-label="Logout from your account">Logout</button>
      </div>
    </div>
    <div class="sidebar-footer">&copy; 2025 Webhook Receiver App</div>
  </aside>
  <main class="main-area" aria-label="Main content">
    <div class="main-inner-content">
      <div class="endpoint-url-row">
        <div id="endpointUrl" tabindex="0" title="Your webhook endpoint URL will appear here"></div>
        <button id="copyEndpointBtn" disabled aria-label="Copy endpoint URL">Copy</button>
      </div>
      <button class="toggle-details-btn" id="toggleAllDetailsBtn" aria-pressed="false">Show All Details</button>
      <div class="requests-table-container" id="requestsTableContainer" role="region" aria-live="polite" aria-atomic="true" aria-relevant="additions">
        <div id="requests">
          <div class="no-requests">No requests have been received yet.</div>
        </div>
      </div>
    </div>
  </main>
</div>
<script src="/socket.io/socket.io.js"></script>
<script>
  (function() {
    const newEndpointBtn = document.getElementById('newEndpointBtn');
    const endpointUrl = document.getElementById('endpointUrl');
    const copyEndpointBtn = document.getElementById('copyEndpointBtn');
    const requestsDiv = document.getElementById('requests');
    const endpointList = document.getElementById('endpointList');
    const g_idsignin = document.getElementById('g_idsignin');
    const userInfo = document.getElementById('userInfo');
    const userEmail = document.getElementById('userEmail');
    const logoutBtn = document.getElementById('logoutBtn');
    const g_idsignin_container = document.getElementById('g_idsignin-container');
    const toggleAllBtn = document.getElementById('toggleAllDetailsBtn');
    const connectionBanner = document.getElementById('connectionBanner');
    const reloadBtn = document.getElementById('reloadBtn');

    const STORAGE_KEY = 'webhookAuthToken';
    const STORAGE_TIME_KEY = 'webhookAuthTokenTime';

    let socket = null;
    let socketConnected = true;
    let currentEndpoint = null;
    let allRequests = [];
    let endpoints = [];
    let authToken = null;
    let currentUser = null;
    let allOpen = false;
    const VIEWED_WEBHOOKS_KEY = 'viewedWebhooks';
    let viewedWebhooks = new Set(JSON.parse(localStorage.getItem(VIEWED_WEBHOOKS_KEY) || '[]'));

    // Set to keep track of viewed requests by index
    let viewedRequests = new Set();

    // Save token and login time
    function saveLogin(token) {
      localStorage.setItem(STORAGE_KEY, token);
      localStorage.setItem(STORAGE_TIME_KEY, Date.now());
    }

    // Clear token and time
    function clearLogin() {
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(STORAGE_TIME_KEY);
    }

    // Load token if still valid (within 30 days)
    function loadLogin() {
      const token = localStorage.getItem(STORAGE_KEY);
      const time = localStorage.getItem(STORAGE_TIME_KEY);
      if (!token || !time) return null;
      const elapsed = Date.now() - Number(time);
      if (elapsed > 30 * 24 * 60 * 60 * 1000) {  // 30 days in milliseconds
        clearLogin();
        return null;
      }
      return token;
    }

    function formatTimestamp(iso) {
      const dt = new Date(iso);
      if (Number.isNaN(dt.getTime())) return iso;
      return dt.toLocaleString();
    }

    function createMethodBadge(method) {
      const m = (method || 'OTHER').toUpperCase();
      const known = ['GET', 'POST', 'PUT', 'DELETE', 'PATCH'];
      const key = known.includes(m) ? m : 'OTHER';
      const span = document.createElement('span');
      span.className = 'method-badge ' + key;
      span.title = `HTTP Method: ${key}`;
      span.textContent = key;
      return span;
    }

    function createIcon(iconClass, title) {
      const icon = document.createElement('span');
      icon.className = `detail-icon ${iconClass}`;
      icon.title = title;
      icon.textContent = iconClass === 'headers' ? 'H' : 'Q';
      return icon;
    }

    function renderRequestRow(req, idx) {
      const tr = document.createElement('tr');
      // Mark endpoint as viewed when requests are loaded
      if (currentEndpoint) {
        viewedWebhooks.add(currentEndpoint);
        localStorage.setItem(VIEWED_WEBHOOKS_KEY, JSON.stringify(Array.from(viewedWebhooks)));
        updateEndpointIndicators();
      }
      
      const tdNum = document.createElement('td');
      tdNum.innerHTML = `<strong>#${idx + 1}</strong><br><small>${formatTimestamp(req.timestamp)}</small>`;
      tr.appendChild(tdNum);
      const tdDetails = document.createElement('td');
      function createDetail(name, obj, isOpen = false) {
        const dtl = document.createElement('details');
        dtl.open = isOpen || allOpen;
        dtl.addEventListener('toggle', () => {
          if (dtl.open && !viewedRequests.has(idx)) {
            viewedRequests.add(idx);
            tr.classList.remove('unopened');
          }
        });
        const sum = document.createElement('summary');
        
        // Add icon instead of text for Headers and Query
        if (name === 'Headers') {
          const icon = createIcon('headers', 'Headers');
          sum.appendChild(icon);
          sum.appendChild(document.createTextNode(` ${Object.keys(obj || {}).length}`));
          sum.appendChild(createMethodBadge(req.method));
        } else if (name === 'Query') {
          const icon = createIcon('query', 'Query Parameters');
          sum.appendChild(icon);
          sum.appendChild(document.createTextNode(` ${Object.keys(obj || {}).length}`));
        } else {
          sum.textContent = `${name} (${Object.keys(obj || {}).length})`;
          
          // Add copy button for Body section
          if (name === 'Body') {
            const copyBtn = document.createElement('button');
            copyBtn.className = 'copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.title = 'Copy to clipboard';
            copyBtn.onclick = (e) => {
              e.stopPropagation();
              const textToCopy = JSON.stringify(obj || {}, null, 2);
              navigator.clipboard.writeText(textToCopy).then(() => {
                copyBtn.textContent = 'Copied!';
                copyBtn.classList.add('copied');
                setTimeout(() => {
                  copyBtn.textContent = 'Copy';
                  copyBtn.classList.remove('copied');
                }, 2000);
              }).catch(err => {
                console.error('Failed to copy:', err);
                copyBtn.textContent = 'Failed';
                setTimeout(() => {
                  copyBtn.textContent = 'Copy';
                }, 2000);
              });
            };
            sum.appendChild(copyBtn);
          }
        }
        
        dtl.appendChild(sum);
        const pre = document.createElement('pre');
        try { pre.textContent = JSON.stringify(obj || {}, null, 2); }
        catch { pre.textContent = 'Invalid JSON'; }
        dtl.appendChild(pre);
        return dtl;
      }
      // Add query parameters with icon
      if (Object.keys(req.query || {}).length > 0) {
        tdDetails.appendChild(createDetail('Query', req.query));
      }
      
      // Add headers with icon
      if (Object.keys(req.headers || {}).length > 0) {
        tdDetails.appendChild(createDetail('Headers', req.headers));
      }
      
      // Add body, open by default
      const bodyContent = typeof req.body === 'object' ? req.body : { value: req.body || '(empty)' };
      tdDetails.appendChild(createDetail('Body', bodyContent, true));
      tr.appendChild(tdDetails);
      return tr;
    }

    function renderTable(requests) {
      requestsDiv.textContent = '';
      if (!requests.length) {
        requestsDiv.innerHTML = `<div class="no-requests" role="alert" tabindex="0">No requests have been received yet.</div>`;
        return;
      }
      const tbl = document.createElement('table');
      const thead = document.createElement('thead');
      thead.innerHTML = `<tr><th># & Timestamp</th><th>Request Data</th></tr>`;
      tbl.appendChild(thead);
      const tbody = document.createElement('tbody');
      requests.forEach((r, i) => {
        tbody.appendChild(renderRequestRow(r, i));
      });
      tbl.appendChild(tbody);
      requestsDiv.appendChild(tbl);
    }

    toggleAllBtn.addEventListener('click', () => {
      allOpen = !allOpen;
      toggleAllBtn.textContent = allOpen ? 'Hide All Details' : 'Show All Details';
      toggleAllBtn.setAttribute('aria-pressed', allOpen.toString());
      requestsDiv.querySelectorAll('details').forEach(d => {
        if (d.open !== allOpen) d.open = allOpen;
      });
      if (allOpen) {
        for (let i = 0; i < allRequests.length; i++) {
          viewedRequests.add(i);
        }
        const trs = requestsDiv.querySelectorAll('tbody tr.unopened');
        trs.forEach(tr => tr.classList.remove('unopened'));
      }
    });

    function updateEndpointIndicators() {
      const items = endpointList.querySelectorAll('li');
      items.forEach(li => {
        const endpointId = li.getAttribute('data-endpoint-id');
        if (endpointId) {
          const dot = li.querySelector('.new-webhook-dot');
          if (viewedWebhooks.has(endpointId)) {
            if (dot) dot.remove();
          } else if (!dot) {
            const newDot = document.createElement('span');
            newDot.className = 'new-webhook-dot';
            newDot.title = 'New webhook';
            const label = li.querySelector('.list-label');
            if (label) label.prepend(newDot);
          }
        }
      });
    }

    async function loadEndpoints() {
      if (!authToken) return;
      try {
        const res = await fetch('/endpoints', { headers: { 'Authorization': `Bearer ${authToken}` } });
        if (!res.ok) throw new Error('Failed to load endpoints');
        endpoints = await res.json();
        endpointList.textContent = '';
        if (!endpoints.length) {
          const li = document.createElement('li');
          li.textContent = 'No endpoints created yet.';
          li.style.fontStyle = 'italic';
          li.tabIndex = -1;
          endpointList.appendChild(li);
          return;
        }
        endpoints.forEach(ep => {
          const li = document.createElement('li');
          li.tabIndex = 0;
          li.setAttribute('role', 'option');
          li.setAttribute('data-endpoint-id', ep.id);
          li.className = (ep.id === currentEndpoint) ? 'selected' : '';
          li.setAttribute('aria-selected', ep.id === currentEndpoint ? 'true' : 'false');
          const spanName = document.createElement('span');
          spanName.className = 'list-label';
          spanName.textContent = ep.name || ep.id;
          
          // Add new webhook dot if not viewed
          if (!viewedWebhooks.has(ep.id)) {
            const newDot = document.createElement('span');
            newDot.className = 'new-webhook-dot';
            newDot.title = 'New webhook';
            spanName.prepend(newDot);
          }
          const actions = document.createElement('div');
          actions.className = 'endpoint-actions';
          const delBtn = document.createElement('button');
          delBtn.textContent = 'ðŸ—‘ï¸';
          delBtn.title = 'Delete this endpoint';
          delBtn.onclick = async e => {
            e.stopPropagation();
            if (!confirm('Are you sure you want to delete this endpoint and all its requests?')) return;
            try {
              const res = await fetch(`/endpoints/${ep.id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${authToken}` }
              });
              if (!res.ok) throw new Error('Delete failed');
              await loadEndpoints();
              if (currentEndpoint === ep.id) {
                currentEndpoint = null;
                endpointUrl.textContent = '';
                copyEndpointBtn.disabled = true;
                allRequests = [];
                viewedRequests.clear();
                renderTable(allRequests);
              }
            } catch (err) {
              alert('Error: ' + err.message);
            }
          };
          actions.appendChild(delBtn);
          li.appendChild(spanName);
          li.appendChild(actions);
          li.onclick = () => selectEndpoint(ep.id);
          li.onkeydown = e => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              selectEndpoint(ep.id);
            }
          };
          endpointList.appendChild(li);
        });
      } catch (err) {
        endpointList.innerHTML = `<li><em>Error loading endpoints.</em></li>`;
      }
    }

    function selectEndpoint(id) {
      currentEndpoint = id;
      endpointUrl.textContent = `${location.protocol}//${location.host}/${id}`;
      copyEndpointBtn.disabled = false;
      allRequests = [];
      viewedRequests.clear();
      renderTable(allRequests);
      if (socketConnected && socket) socket.emit('join', id);
      [...endpointList.children].forEach(li => {
        li.classList.toggle('selected', li.querySelector('.list-label')?.textContent === (endpoints.find(ep => ep.id === id)?.name || id));
        li.setAttribute('aria-selected', li.classList.contains('selected') ? 'true' : 'false');
      });
      
      // Mark as viewed when selected
      if (id && !viewedWebhooks.has(id)) {
        viewedWebhooks.add(id);
        localStorage.setItem(VIEWED_WEBHOOKS_KEY, JSON.stringify(Array.from(viewedWebhooks)));
        updateEndpointIndicators();
      }
    }

    copyEndpointBtn.onclick = () => {
      const txt = endpointUrl.textContent.trim();
      if (!txt) {
        alert("No URL available.");
        return;
      }
      navigator.clipboard.writeText(txt).then(() => {
        copyEndpointBtn.textContent = 'Copied!';
        copyEndpointBtn.disabled = true;
        setTimeout(() => {
          copyEndpointBtn.textContent = 'Copy';
          copyEndpointBtn.disabled = false;
        }, 2000);
      }).catch(() => alert("Copy failed"));
    };

    function connectSocket() {
      socket = io({ reconnection: true, reconnectionAttempts: 10, reconnectionDelay: 1000 });

      socket.on('disconnect', () => {
        socketConnected = false;
        connectionBanner.style.display = 'block';
      });

      reloadBtn.onclick = () => window.location.reload();

      socket.on('connect', () => {
        socketConnected = true;
        connectionBanner.style.display = 'none';
        if (currentEndpoint) socket.emit('join', currentEndpoint);
      });

      socket.on('connect_error', err => {
        console.error('Socket.IO connect error:', err);
        connectionBanner.style.display = 'block';
      });

      socket.on('init_requests', data => {
        allRequests = [...data];
        viewedRequests.clear();
        renderTable(allRequests);
        allOpen = false;
        toggleAllBtn.textContent = 'Show All Details';
        toggleAllBtn.setAttribute('aria-pressed', 'false');
      });

      socket.on('new_request', req => {
        allRequests.unshift(req);
        renderTable(allRequests);
        allOpen = false;
        toggleAllBtn.textContent = 'Show All Details';
        toggleAllBtn.setAttribute('aria-pressed', 'false');
      });

      socket.on('error', msg => alert(msg));
    }

    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === 'visible' && !socketConnected) {
        window.location.reload();
      }
    });

    newEndpointBtn.onclick = async () => {
      if (!authToken) {
        alert('Please sign in to create a new endpoint.');
        return;
      }
      let name = prompt("Enter a name for your new webhook endpoint (optional):", "");
      if (name !== null) name = name.trim();
      try {
        const res = await fetch('/new', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ name: name || undefined })
        });
        if (!res.ok) throw new Error('Create failed');
        const data = await res.json();
        await loadEndpoints();
        selectEndpoint(data.id);
      } catch (err) {
        alert('Error: ' + err.message);
      }
    };

    // Save token and timestamp on successful login
    function saveLogin(token) {
      localStorage.setItem(STORAGE_KEY, token);
      localStorage.setItem(STORAGE_TIME_KEY, Date.now());
    }

    // Clear stored token on logout
    function clearLogin() {
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(STORAGE_TIME_KEY);
    }

    // Load token if not expired (>30 days = expired)
    function loadLogin() {
      const token = localStorage.getItem(STORAGE_KEY);
      const time = localStorage.getItem(STORAGE_TIME_KEY);
      if (!token || !time) return null;
      if ((Date.now() - Number(time)) > 30 * 24 * 60 * 60 * 1000) {  // 30 days in milliseconds
        clearLogin();
        return null;
      }
      return token;
    }

    // Modified to save token persistently
    function handleCredentialResponse(response) {
      if (!response.credential) {
        alert("Missing credentials");
        return;
      }
      fetch('/auth/google', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token: response.credential }),
      }).then(r => {
        if (!r.ok) throw new Error('Authentication failed');
        return r.json();
      }).then(data => {
        authToken = response.credential;
        saveLogin(authToken); // Persist login token
        currentUser = data.user;
        updateUIOnSignIn();
        return loadEndpoints();
      }).catch(err => {
        alert('Authentication error: ' + err.message);
        googleLogout();
      });
    }

    function updateUIOnSignIn() {
      g_idsignin_container.style.display = 'none';
      userInfo.style.display = 'flex';
      userEmail.textContent = currentUser.email;
      userEmail.title = currentUser.email;
      newEndpointBtn.disabled = false;
    }

    function updateUIOnSignOut() {
      g_idsignin_container.style.display = 'block';
      userInfo.style.display = 'none';
      userEmail.textContent = '';
      userEmail.title = '';
      newEndpointBtn.disabled = true;
      currentEndpoint = null;
      endpointUrl.textContent = '';
      copyEndpointBtn.disabled = true;
      allRequests = [];
      viewedRequests.clear();
      renderTable(allRequests);
      allOpen = false;
      toggleAllBtn.textContent = 'Show All Details';
      toggleAllBtn.setAttribute('aria-pressed', 'false');
      endpointList.textContent = '';
    }

    logoutBtn.onclick = () => googleLogout();

    // Clear saved token on logout
    function googleLogout() {
      authToken = null;
      currentUser = null;
      clearLogin();
      updateUIOnSignOut();
      google.accounts.id.disableAutoSelect();
    }

    // Load stored token on page load and validate it
    function checkStoredSession() {
      const savedToken = loadLogin();
      if (savedToken) {
        authToken = savedToken;
        fetch('/auth/google', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token: authToken }),
        }).then(r => {
          if (!r.ok) throw new Error('Authentication failed');
          return r.json();
        }).then(data => {
          currentUser = data.user;
          updateUIOnSignIn();
          loadEndpoints();
        }).catch(() => {
          googleLogout();
        });
      } else {
        updateUIOnSignOut();
      }
    }

    window.onload = () => {
      google.accounts.id.initialize({
        client_id: '961084624040-mq5mjicgbek07uk3ihhjr69ft695u7a7.apps.googleusercontent.com',
        callback: handleCredentialResponse,
        auto_select: false,
        cancel_on_tap_outside: true,
      });
      google.accounts.id.renderButton(g_idsignin, {
        theme: 'outline',
        size: 'large',
        width: '100%',
        locale: 'en',
      });
      google.accounts.id.prompt();
      connectSocket();
      checkStoredSession();
    };
  })();
</script>
  <script>
  // Set light theme by default
  document.documentElement.setAttribute('data-theme', 'light');
  </script>
</body>
</html>
